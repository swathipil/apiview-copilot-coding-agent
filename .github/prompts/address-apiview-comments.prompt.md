---
mode: 'agent'
tools: ['CreatePullRequest', 'UpdatePullRequest', 'SearchRepositories', 'CreateIssue'] # 'GetApiViewComments'
---

# APIView Comment Resolution and PR Workflow

## 🚨 CRITICAL RULES SUMMARY 🚨

1. **REMOTE SEARCH ONLY**: Always search for code in remote repositories, never in local files
2. **GENERATED CODE CHECK**: Always check for header "Code generated by Microsoft (R) Python Code Generator."
3. **MODIFY CORRECTLY**:
   - Generated files from TypeSpec → Modify TypeSpec source or _patch.py files
   - Generated files from Swagger → DO NOT update (legacy approach no longer supported)
   - Handwritten files → Modify directly

Follow these steps to address APIView comments and create a pull request in the azure-sdk-for-<language> repositories or the azure-rest-api-specs repository:

## Step 1: Gather APIView Comments
- Retrieve APIView comments for the target package or module.
- If comments are provided as a JSON file, analyze the file for actionable feedback.
- If comments are not available, prompt the user to provide the APIView comments or a link to the APIView review.

## Step 2: Prepare for Code Changes
- Describe the step-by-step thought process while going through the next steps.

### CRITICAL: Remote Repository Search Policy
- **⚠️ NEVER search local files for symbols, code structure, or source information**
- **⚠️ ALWAYS perform ALL code search and symbol lookups in the remote GitHub repositories**
- **⚠️ ALWAYS use the SearchRepositories tool or equivalent to search across remote repositories**
- **⚠️ Local repository files should ONLY be used for making final changes, never for discovery**
- Example correct approach: "I'll search for the SchemaFormat class in the remote Azure/azure-sdk-for-python repository"
- DO identify the target repository, package, and branch by searching the following remote repositories.
  - `azure-sdk-for-python`: https://github.com/Azure/azure-sdk-for-python (for handwritten code and _patch.py files)
  - `azure-rest-api-specs`: https://github.com/Azure/azure-rest-api-specs/ (for TypeSpec source files ONLY)
  - `azure-sdk-tools`: https://github.com/Azure/azure-sdk-tools (for filing APIView bugs)
- DO identify all target repositories, since multiple repositories may require changes.
- DO take the following steps when identifying the target repository and branch:
  - If the comments apply to a file in the `azure-sdk-for-<language>` repo:
      - **ALWAYS check the top of the file for the presence of this exact header line: "Code generated by Microsoft (R) Python Code Generator."**
      - **If this specific header is found**, this is a generated file:
        - DO NOT make changes directly to this generated file
        - Check if the file was generated from TypeSpec (usually indicated by a `tsp-location.yaml` file at the package directory root)
        - If generated from TypeSpec:
          - Identify the target TypeSpec file in the `azure-rest-api-specs` repo
          - Make required changes in the TypeSpec file
          - If changes cannot be made in TypeSpec due to limitations, make changes in handwritten `_patch.py` files in `azure-sdk-for-<language>` repo instead
        - If generated from Swagger (usually indicated by a `swagger` folder at the package directory root):
          - DO NOT UPDATE - Swagger-based code generation is legacy and no longer supported for updates
          - Instead, make changes in handwritten `_patch.py` files in `azure-sdk-for-<language>` repo
      - **If this header is NOT present**, this is a handwritten file:
        - Changes should be made directly to this file in the `azure-sdk-for-<language>` repo
  - If the comment says there's an APIView bug, find if an issue exists for it in the azure-sdk-tools repo. Otherwise, create an issue with the title prefixed by "[Python APIView]".
- Fetch the target remote branch and create a new branch off the target branch.

## Step 3: Address APIView Comments

### Handling Generated vs. Handwritten Code

```
╔════════════════════════╗
║ APIView Comment on File ║
╚═════════════╦══════════╝
              ▼
┌─────────────────────────┐
│ Check file header for:  │
│ "Code generated by      │
│ Microsoft (R) Python    │
│ Code Generator."        │
└──────────┬──────────────┘
           │
           ▼
    ┌──────────────┐     No      ┌─────────────────────┐
    │ Header found?├────────────►│ Make changes        │
    └──────┬───────┘             │ directly in file    │
           │                     │ (handwritten code)  │
           │ Yes                 └─────────────────────┘
           ▼
┌──────────────────────────────┐
│ DO NOT modify file directly! │
└──────────┬───────────────────┘
           │
           ▼
┌───────────────────────────┐
│ Generated from TypeSpec?  │
└───────────┬───────┬───────┘
            │       │
           Yes      │ No (Swagger)
            │       │
            ▼       ▼
┌──────────────┐  ┌──────────────────────────────┐
│ Find TypeSpec│  │ DO NOT UPDATE SWAGGER SOURCE │
│ in azure-    │  │ (Legacy approach)            │
│ rest-api-    │  └──────────────┬───────────────┘
│ specs repo   │                 │
└──────┬───────┘                 │
       │                         │
       ▼                         ▼
┌─────────────────────────────┐  ┌─────────────────────┐
│ Can changes be applied      │  │ Add changes to      │
│ in TypeSpec?                │  │ _patch.py file      │
└─────────┬───────────────────┘  │ in SDK repo         │
          │                      └─────────────────────┘
  ┌───────┴───────┐  ┌───────────────────┐
  │ Yes: Modify   │  │ No: Add changes   │
  │ TypeSpec file │  │ to _patch.py file │
  └───────────────┘  └───────────────────┘
```

- For each comment, make the necessary code changes following Azure SDK and language-specific best practices
- Ignore the `/build/` folder
- Ensure code is maintainable and adheres to repository guidelines
- **ALWAYS verify the file header before making any changes**
- **IMPORTANT: Code generated from Swagger (not TypeSpec) should NOT have the source updated - use _patch.py files instead**

## Step 4: Commit and Push Changes
- Commit your changes with a clear message referencing the APIView comments addressed.
- Push the branch to the remote repository.

## Step 5: Create a Draft Pull Request
- Generate a draft pull request with a title such as `[WIP] Fix <package> APIView comments`.
- In the PR description, summarize the APIView comments addressed and any notable changes.
- Assign reviewers or labels as needed.
- Note: PRs can be created in either the azure-sdk-for-<language> repositories or the azure-rest-api-specs repository, depending on where the changes are required.

## Step 6: Finalize the Pull Request
- Once all comments are addressed and the PR is ready for review, update the PR title and description to remove `[WIP]` and reflect the completed work. DO keep status as draft.
- Notify reviewers for final review and merge.