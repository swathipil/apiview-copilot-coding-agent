---
mode: 'agent'
tools: ['CreatePullRequest', 'UpdatePullRequest', 'SearchRepositories', 'CreateIssue'] # 'GetApiViewComments'
---

# APIView Comment Resolution and PR Workflow

## 🚨 CRITICAL RULES SUMMARY 🚨

1. **REMOTE SEARCH ONLY**: Always search for code in remote repositories, never in local files
2. **GENERATED CODE CHECK**: Always check for header "Code generated by Microsoft (R) Python Code Generator."
3. **MODIFY CORRECTLY**:
   - Generated files → Modify TypeSpec/swagger or _patch.py files
   - Handwritten files → Modify directly

Follow these steps to address APIView comments and create a pull request in the azure-sdk-for-<language> repositories or the azure-rest-api-specs repository:

## Step 1: Gather APIView Comments
- Retrieve APIView comments for the target package or module.
- If comments are provided as a JSON file, analyze the file for actionable feedback.
- If comments are not available, prompt the user to provide the APIView comments or a link to the APIView review.

## Step 2: Prepare for Code Changes
- Describe the step-by-step thought process while going through the next steps.

### CRITICAL: Remote Repository Search Policy
- **⚠️ NEVER search local files for symbols, code structure, or source information**
- **⚠️ ALWAYS perform ALL code search and symbol lookups in the remote GitHub repositories**
- **⚠️ ALWAYS use the SearchRepositories tool or equivalent to search across remote repositories**
- **⚠️ Local repository files should ONLY be used for making final changes, never for discovery**
- Example correct approach: "I'll search for the SchemaFormat class in the remote Azure/azure-sdk-for-python repository"
- DO identify the target repository, package, and branch by searching the following remote repositories.
  - `azure-sdk-for-python`: https://github.com/Azure/azure-sdk-for-python
  - `azure-rest-api-specs`: https://github.com/Azure/azure-rest-api-specs/
  - `azure-sdk-tools`: https://github.com/Azure/azure-sdk-tools
- DO identify all target repositories, since multiple repositories may require changes.
- DO take the following steps when identifying the target repository and branch:
  - If the comments apply to a file in the `azure-sdk-for-<language>` repo:
      - **ALWAYS check the top of the file for the presence of this exact header line: "Code generated by Microsoft (R) Python Code Generator."**
      - **If this specific header is found**, this is a generated file:
        - DO NOT make changes directly to this generated file
        - Identify the target TypeSpec or swagger file in the `azure-rest-api-specs` repo 
        - Make required changes in the TypeSpec or swagger file
        - If changes cannot be made in TypeSpec due to limitations, make changes in handwritten `_patch.py` files in `azure-sdk-for-<language>` repo instead
      - **If this header is NOT present**, this is a handwritten file:
        - Changes should be made directly to this file in the `azure-sdk-for-<language>` repo
  - If the comment says there's an APIView bug, find if an issue exists for it in the azure-sdk-tools repo. Otherwise, create an issue with the title prefixed by "[Python APIView]".
- Fetch the target remote branch and create a new branch off the target branch.

## Step 3: Address APIView Comments

### Handling Generated vs. Handwritten Code

```
╔════════════════════════╗
║ APIView Comment on File ║
╚═════════════╦══════════╝
              ▼
┌─────────────────────────┐
│ Check file header for:  │
│ "Code generated by      │
│ Microsoft (R) Python    │
│ Code Generator."        │
└──────────┬──────────────┘
           │
           ▼
    ┌──────────────┐     Yes     ┌──────────────────────┐
    │ Header found?├────────────►│ DO NOT modify file   │
    └──────┬───────┘             │ directly!            │
           │                     └──────────┬───────────┘
           │ No                            │
           ▼                               ▼
┌─────────────────────┐          ┌──────────────────────┐
│ Make changes        │          │ Find TypeSpec/swagger │
│ directly in file    │          │ in azure-rest-api-   │
│ (handwritten code)  │          │ specs repository      │
└─────────────────────┘          └──────────┬───────────┘
                                           │
                                           ▼
                              ┌──────────────────────────────┐
                              │ Can changes be applied       │
                              │ in TypeSpec/swagger?         │
                              └───────────┬──────────────────┘
                                          │
                  ┌────────────────────┐  │  ┌───────────────────────┐
                  │ Yes: Modify the    │◄──┴──►No: Add changes to    │
                  │ TypeSpec/swagger   │      │ _patch.py file in SDK │
                  └────────────────────┘      └───────────────────────┘
```

- For each comment, make the necessary code changes following Azure SDK and language-specific best practices
- Ignore the `/build/` folder
- Ensure code is maintainable and adheres to repository guidelines
- **ALWAYS verify the file header before making any changes**

## Step 4: Commit and Push Changes
- Commit your changes with a clear message referencing the APIView comments addressed.
- Push the branch to the remote repository.

## Step 5: Create a Draft Pull Request
- Generate a draft pull request with a title such as `[WIP] Fix <package> APIView comments`.
- In the PR description, summarize the APIView comments addressed and any notable changes.
- Assign reviewers or labels as needed.
- Note: PRs can be created in either the azure-sdk-for-<language> repositories or the azure-rest-api-specs repository, depending on where the changes are required.

## Step 6: Finalize the Pull Request
- Once all comments are addressed and the PR is ready for review, update the PR title and description to remove `[WIP]` and reflect the completed work. DO keep status as draft.
- Notify reviewers for final review and merge.